import osmnx as ox
import rasterio
import numpy as np

def get_comfort_index_at_coordinates(raster_path, lat, lon):
    """
    Get the comfort index at a specific coordinate from a raster map.
    """
    with rasterio.open(raster_path) as src:
        # Get the transformation (georeferencing information)
        transform = src.transform

        # Get the row, col indices of the raster at the given coordinates (lat, lon)
        row, col = src.index(lon, lat)
        raster_array = src.read(1)
        if row >= 0 and row < raster_array.shape[0] and col >= 0 and col < raster_array.shape[1]:
            comfort_index = raster_array[row, col]
        else:
            comfort_index = None  # or handle the invalid index case appropriately


        # Read the comfort index value from the raster at the specified pixel
        #comfort_index = src.read(1)[row, col]

        # Normalize the comfort index to be between 0 and 1 (if necessary)
        #comfort_index = comfort_index / max_value if needed

    return comfort_index


def calculate_edge_comfort_index(graph, raster_path):
    """
    Calculate the comfort index for each edge in a graph based on the raster map.
    
    Args:
        graph: An OSMnx graph object.
        raster_path: Path to the raster file containing comfort index values.
    
    Returns:
        A dictionary mapping each edge to its comfort index.
    """
    edge_comfort_index = {}
    i=0
    for u, v, data in graph.edges(data=True):
        i=i+1
        # Get coordinates (latitude, longitude) of the start (u) and end (v) nodes
        start_lat = graph.nodes[u]['y']
        start_lon = graph.nodes[u]['x']
        end_lat = graph.nodes[v]['y']
        end_lon = graph.nodes[v]['x']

        # Get the comfort index for the start and end points
        start_comfort_index = get_comfort_index_at_coordinates(raster_path, start_lat, start_lon)
        end_comfort_index = get_comfort_index_at_coordinates(raster_path, end_lat, end_lon)

        # Average the comfort index at both ends of the edge
        if start_comfort_index!=None and end_comfort_index!=None:
            edge_comfort_index[(u,v)] = (start_comfort_index + end_comfort_index) / 2
        else:
            edge_comfort_index[(u,v)]=1
        print(i,edge_comfort_index[(u,v)])

    return edge_comfort_index

# Load the city graph using OSMnx (e.g., for Cluj-Napoca)
place_name = "Cluj-Napoca, Romania"
graph = ox.graph_from_place(place_name, network_type="walk")

# Path to your comfort index raster
raster_path = "BackEnd/comfort_index.tif"

# Calculate the comfort index for each edge in the graph
edge_comfort_index = calculate_edge_comfort_index(graph, raster_path)

# Print some results
for edge, comfort_index in list(edge_comfort_index.items())[:30]:  # Show first 5 edges
    print(f"Edge {edge}: Comfort Index = {comfort_index}")
