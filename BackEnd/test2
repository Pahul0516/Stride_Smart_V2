import numpy as np
from shapely.geometry import LineString
from rasterio.mask import mask
import rasterio
import osmnx as ox

def calculate_comfort_index(G,edge, raster_file_path):
    """
    Calculate the comfort index for an edge in the graph using raster data from a local file,
    considering the exact geometry of the edge. Darker shades in the raster represent higher comfort.
    """

    buffer_distance = 0.000090  # Buffer around the edge geometry
    u, v, edge_data = edge
    
    # If the edge has a geometry, use it; otherwise, create a geometry from node coordinates
    if 'geometry' in edge_data:
        edge_geometry = edge_data['geometry']
    else:
        u_coords = G.nodes[u]['x'],G.nodes[u]['y']
        v_coords = G.nodes[v]['x'], G.nodes[v]['y']
        edge_geometry = LineString([u_coords, v_coords])

    # Create a buffer around the edge geometry to account for nearby pixels
    try:
        edge_buffer = edge_geometry.buffer(buffer_distance)
    except Exception as e:
        print(e)
        return None

    # If the buffer is not valid or empty, return None
    if not edge_buffer.is_valid or edge_buffer.is_empty:
        return None

    # Convert the buffer geometry into GeoJSON and mask the raster with this shape
    shapes = [edge_buffer.__geo_interface__]
    
    # Open the raster from the local file path
    with rasterio.open(raster_file_path) as src:
        out_image, out_transform = mask(src, shapes, crop=True)

    # Flatten the image array
    out_image = out_image.flatten()

    # Check the pixel values (comfort index is higher for darker pixels)
    comfort_threshold = 0  # Example threshold for pixels
    comfort_pixels = np.sum(out_image < comfort_threshold)  # Darker pixels (lower values) represent higher comfort
    total_pixels = out_image.size

    # If there are no pixels, return 1 (indicating maximum comfort)
    if total_pixels == 0:
        return 1

    # Calculate comfort index as the ratio of darker pixels (comfort) to total pixels
    comfort_index = comfort_pixels / total_pixels * 100
    return comfort_index

def comfort_raster(G,raster_file_path):
    # Iterate through the edges of the graph
    i = 0
    for edge in G.edges(data=True):
        i += 1
        # Calculate comfort index for each edge and update the edge data
        comfort_index = calculate_comfort_index(G,edge, raster_file_path)
        print(i,comfort_index)
        #u, v, data = edge
        #data['comfort_index'] = comfort_index

place_name = "Cluj-Napoca, Romania"
graph = ox.graph_from_place(place_name, network_type="walk")

# Path to your comfort index raster
raster_path = "BackEnd/comfort_index.tif"

# Calculate the comfort index for each edge in the graph
comfort_raster(graph,raster_path)