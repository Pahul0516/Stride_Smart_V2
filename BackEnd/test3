import rasterio

def get_comfort_index_at_point(raster_path, lat, lon):
    # Open the raster file
    with rasterio.open(raster_path) as src:
        # Get the raster's transform and CRS
        transform = src.transform
        crs = src.crs

        # Convert latitude/longitude to pixel indices
        row, col = src.index(lon, lat)

        # Read the value of the comfort index at that point (assuming comfort index is in the first band)
        comfort_value = src.read(1)[row, col]
        return comfort_value

# Example usage:
raster_path = 'BackEnd/comfort_index.tif'  # Path to the raster file
latitude = 46.736922171  # Example latitude
longitude =  23.551265576  # Example longitude # very white point => very green area => comfort index should be low to be taken

comfort_index = get_comfort_index_at_point(raster_path, latitude, longitude)
print(f"Comfort index at point ({latitude}, {longitude}): {comfort_index}")

import rasterio
import numpy as np
from shapely.geometry import LineString
import osmnx as ox
import networkx as nx
import rasterio
from shapely.geometry import LineString
import numpy as np

import osmnx as ox
import networkx as nx
import rasterio
from shapely.geometry import LineString
import numpy as np

def calculate_average_comfort_index(G,edge, raster_path):
    """
    Calculate the average comfort index for an edge in the graph using raster data.
    
    Parameters:
    edge: A tuple (u, v, edge_data) where edge_data contains the geometry of the edge.
    raster_path: Path to the raster file containing the comfort index data.
    
    Returns:
    float: The average comfort index for the edge, or None if the edge has no geometry or the index is invalid.
    """
    # Get the geometry of the edge
    u, v, edge_data = edge
    if 'geometry' in edge_data:
        edge_geometry = edge_data['geometry']
    else:
        u_coords = G.nodes[u]['x'], G.nodes[u]['y']
        v_coords = G.nodes[v]['x'], G.nodes[v]['y']
        edge_geometry = LineString([u_coords, v_coords])
    
    # Open the raster file
    with rasterio.open(raster_path) as src:
        transform = src.transform
        crs = src.crs
        
        # Sample points along the edge (e.g., at 10 meter intervals)
        sample_points = list(edge_geometry.coords)
        
        comfort_values = []
        
        # For each sample point, calculate the comfort index
        for point in sample_points:
            lon, lat = point
            
            # Convert the geographic coordinates (lon, lat) to pixel indices (row, col)
            row, col = src.index(lon, lat)
            
            if row < 0 or row >= src.height or col < 0 or col >= src.width:
                # Skip this point if it's out of bounds
                continue

            # Read the comfort index value at that point (first band assumed)
            comfort_value = src.read(1)[row, col]
            
            # Append the comfort value if it's valid (check for NoData)
            if comfort_value != src.nodata:
                comfort_values.append(comfort_value)
        
        # If we have any valid comfort values, calculate the average
        if comfort_values:
            return np.mean(comfort_values)
        else:
            return None

def add_comfort_index_to_osmnx_graph(graph, raster_path, output_graphml):
    """
    Add the comfort index for each edge in the OSMnx graph using raster data and save to a GraphML file.
    
    Parameters:
    graph: OSMnx NetworkX graph containing the edges.
    raster_path: Path to the raster file containing the comfort index data.
    output_graphml: Path to the output GraphML file.
    """
    i=0
    # Iterate through all edges in the OSMnx graph
    for u, v, edge_data in graph.edges(data=True):
        i+=1
        # Calculate the average comfort index for the edge
        comfort_index = calculate_average_comfort_index(graph,(u, v, edge_data), raster_path)
        
        # Store the comfort index as an edge attribute
        if comfort_index is not None:
            data['comfort_index'] = comfort_index
            print(i,comfort_index)
    
    # Save the graph to a GraphML file
    nx.write_graphml(graph, output_graphml)
    print(f"Graph with comfort index data saved to: {output_graphml}")

